#!/bin/sh

cd "$HOME/Executables"
mkdir -p 'go/bin' 'pipx/bin' 'gem/bin' 'luarocks/bin' 'npm/bin' 'cargo/bin' 'stack/bin'
cd "$HOME"
# shellcheck source=startup.sh
echo 'Created some directories before adding to $PATH'
if [ -z "$PROFILE_SET" ]; then
	# shellcheck source=.profile
	. "$HOME/.profile"
	export PROFILE_SET=2
fi
echo "Running bootstrap for $MACHINE"

bootstrap_dir="$HOME/Executables/shell-scripts/bootstrap"
updates_dir="$HOME/Executables/shell-scripts/updates"

# TODO: Add support for FreeBSD (TrueOS with Area51 repo)
if [ "$MACHINE" = 'Linux' ]; then
	if [ -f /usr/lib/os-release ]; then
		echo 'Detected Linux'
		# my scripts only work on Fedora atm. TODO: add support for Debian
		# shellcheck source=/dev/null
		. /usr/lib/os-release
		if [ "$NAME" = 'Fedora' ]; then
			echo 'Installing dnf packages for Fedora'
			sudo sh "$bootstrap_dir/sudo-dnf.sh"
		fi
		dash "$bootstrap_dir/flatpak.sh"
		dash "$updates_dir/chromium.sh"
	fi
elif [ "$MACHINE" = 'Darwin' ]; then
	echo 'Installing homebrew packages'
	sh "$bootstrap_dir/homebrew-install.sh"
else
	echo 'Unrecognized OS.'
	exit
fi

dash "$bootstrap_dir/cargo.sh"

gem pristine msgpack
gem install neovim

dash "$bootstrap_dir/python.sh"
dash "$bootstrap_dir/zplugin.sh"
dash "$updates_dir/node.sh"
dash "$updates_dir/stack.sh"
dash "$updates_dir/go.sh"
echo 'Bootstrap finished! Reboot and try running "update-all" to make sure this worked.'

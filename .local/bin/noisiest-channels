#!/usr/bin/env dash

# Analyze the last 24-hours (start-time rounded down to the nearest whole hour)
# of logs in $WEECHAT_HOME/logs, and output a sorted list of logfiles in
# descending order of messages, excluding bots, join/leave, etc.
# sample output of `noisiest-channels | sed 30q`: https://clbin.com/nBDKC
# Should work on any POSIX that also supports "date -d"
log_dir="${WEECHAT_HOME-${HOME-~}/.weechat}/logs"
ansi_escape='\x1B\[[0-9;]*[JKmsu]'
# example: 2020-02-22 19:43:20
msg_prefix='^20[0-9].-[0-1][0-9]-[0-3][0-9] [0-2][0-9]:[0-5][0-9]:[0-5][0-9]\s*'
nick_prefix='\+|%|@'
# Pelosi on efnet; ShinyMetal,gonzobot, SubWatch on snoonet; #mockturtle
# on freenode.#lobsters; JARVIS on 2600net; #weebot on freenode.#weechat,
# Internets and YT-info on rizon.#chat,
bots='gitter|Pelosi|ShinyMetal|mockturtle|weebot|gonzobot|SubWatch|JARVIS|Internets|YT-info'
# filter out join/leave, channel messages, bots, and /away messages
filter_out="^((\-\->?|<\-\-|($nick_prefix)?($bots))\s|\[.* away: .*]$)"
date_start="$(date -d @"$(expr $(date +%s) - 172800)" '+%Y-%m-%d %H')"
channel_noise() {
	for file in "$log_dir"/irc.*.[#]*.weechatlog; do
		echo "$(basename "$file") $(
			sed -n -e "s/$ansi_escape//g" -e "/^$date_start/,\$p" "$file" \
				| sed -e "s/$msg_prefix//g" \
				| grep -Ecv "$filter_out"
		)"
	done
}

# sort output by number of lines, and number the result
channel_noise | sort -n -k 2 -r | nl -w2 -s'. '
# vi:ft=sh

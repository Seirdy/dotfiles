#!/usr/bin/env dash
# Runs a full update and saves log files.
# Full update includes:
# - system packages with system package manager
# - cargo packages
# - go packages (installed via go-get)
# - pipx packages (python pkgs in their own venvs with entries in $PATH)
# - global pip3 packages (including pipx)
# - global npm packages
# - global luarocks
# - global rubygems
# - flatpaks
# - chromium (via chromium-latest-linux).
# Everything is run simultaneously in the background. The system update is also
# displayed in the interactive session via `tee` so I can enter my root pw and
# watch it happen.
# Log files can be big, so all but the most recent are compressed.
# TODO: Update neovim plugins
# TODO: use npx to contain npm packages
# TODO: determine number of cores and use it to run the max number of parallel
# processes.

###########
# Prepare #
###########

# Compress old logs and create directory for new logs #

script_dir="$HOME/Executables/shell-scripts/updates"
cd "$script_dir" || return 1
fd -t f -e sh -x chmod +x # So I can run the scripts with their shebangs
cd "$XDG_DATA_HOME/update-all/logs" || return 1
printf "%s" 'Compressing old log: ' # Combines with first line of p7zip output

fd -t d -x 7z a -bd -m0=lzma -mx=9 -y "{/}.7z" "{}" \
	| rg -v 'Copyright|p7zip Version|Scanning the drive|Items to compress' \
	| rg -v 'Files read from disk|Everything is Ok' \
	| sed '/^$/d' \
	| sed '/\.7z/N;s/\nArchive size:/,/'

fd -t d -x rm -rf
time_start=$(date '+%s')
mkdir "$time_start"
cd "$time_start" || return 2
log_dir="$PWD"
# Use log_dir in below scripts.
export log_dir
echo # newline

#####################
# Logging functions #
#####################

# For both these functions, the input corresponds to a file in
# $script_dir with the ".sh" extension added.
# Each function logs output to $log_dir

# Adding "2>&1" and "< /dev/null" to nohup commands will
# hide nohup output message ("nohup: ignoring input and...")

# Run and log in background
log_bg() {
	echo "Starting update: $1"
	nohup "$script_dir/$1.sh" >"$log_dir/$1-$time_start.log" 2>&1 &
}

# Run and log in foreground (live-preview log file in interactive session)
log_fg() {
	echo "Starting update: $1"
	"$script_dir/$1.sh" | tee "$log_dir/$1-$time_start.log"
}

###############
# Run updates #
###############

log_bg 'pip-pipx'         # see https://pipxproject.github.io/pipx/
log_bg 'node'             # npm packages
log_bg 'rubygem-luarocks' # combining gem and luarocks since they update quickly
log_bg 'go'               # build go packages installed with "go get" (slow)
log_bg 'cargo'            # rust packages (infrequent, extremely cpu-heavy)
log_bg 'zplugin'          # update zplugin itself, zsh plugins, and zpmod
log_bg 'kitty'            # build kitty from source, latest commit

if [ "$MACHINE" = 'Linux' ]; then
	log_bg 'newsboat' # build newsboat from source, latest commit
	log_bg 'stack'    # haskell packages (infrequent updates, cpu-heavy, slow)
	log_bg 'flatpak'  # repair and update user-installed flatpaks
	log_bg 'chromium' # secondary browser; script based on chromium-latest-linux
	echo              # line break
	log_fg 'dnf'      # system-wide update, autoremoval, and repo caching.

elif [ "$MACHINE" = 'Darwin' ]; then
	echo
	log_fg 'homebrew' # repo-caching and updating of homebrew formulae and casks

else
	echo 'Unsupported machine for system package updates'
	echo "Your machine is $MACHINE"
fi

# vim: filetype=sh
